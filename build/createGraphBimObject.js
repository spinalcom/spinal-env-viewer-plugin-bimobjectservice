"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _spinalEnvViewerGraphService = require("spinal-env-viewer-graph-service");

var _spinalServiceAssemblyManager = require("spinal-service-assembly-manager");

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

const BIM_OBJECT_CONTEXT_TYPE = "BIMObjectContext";
const BIM_OBJECT_NODE_TYPE = "BIMObject";
const BIM_OBJECT_RELATION_NAME = "hasBIMObject";
const REFERENCE_OBJECT_RELATION_NAME = "hasReferenceObject";
const BIM_OBJECT_RELATION_TYPE = _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE;

const assemblyManger = _spinalServiceAssemblyManager.assemblyManagerService;
const bimObjectService = {

  getGraph() {
    return _spinalEnvViewerGraphService.SpinalGraphService.getGraph();
  },

  createBIMObject(dbid, name) {
    return assemblyManger.createBimObj(dbid, name, assemblyManger._getCurrentModel());
  },

  getBIMObject(dbid) {
    return assemblyManger.getBimObjectFromViewer(dbid, assemblyManger._getCurrentModel()).then(bimObj => {
      if (bimObj) {
        console.log('bimObj', bimObj);
        return _spinalEnvViewerGraphService.SpinalGraphService.getRealNode(bimObj.id);
      }
      return undefined;
    });
  },

  addBIMObject(context, parent, dbId, name) {
    return this.getBIMObject(dbId).then(bimObject => {
      if (bimObject) {
        return _spinalEnvViewerGraphService.SpinalGraphService.addChildInContext(parent.info.id.get(), bimObject.info.id.get(), context.info.id.get(), BIM_OBJECT_RELATION_NAME, BIM_OBJECT_RELATION_TYPE);
      }
      return assemblyManger.createBimObj(dbId, name, assemblyManger._getCurrentModel()).then(bimObj => {
        console.log('create then', bimObj);
        return this.addBIMObject(context, parent, dbId, name);
      });
    }).catch(e => {
      console.error(e);
    });
  },

  removeBIMObject(parent, child) {
    _spinalEnvViewerGraphService.SpinalGraphService.removeChild(parent.info.id.get(), child.info.id.get(), BIM_OBJECT_RELATION_NAME, BIM_OBJECT_RELATION_TYPE);
  },

  deleteBIMObject(dbId) {
    return this.getBIMObject(dbId).then(BIMobj => {
      if (BIMobj) return _spinalEnvViewerGraphService.SpinalGraphService.removeFromGraph(BIMobj.info.id.get());
      // @ts-ignore
      throw Error("The dbId has no BIM object");
    });
  },

  addReferenceObject(parent, dbId, name) {
    var _this = this;

    return _asyncToGenerator(function* () {

      let node;

      if (dbId instanceof _spinalEnvViewerGraphService.SpinalNode) {
        node = dbId;
      } else {
        node = yield _this.getBIMObject(dbId);

        if (node === undefined) {

          node = yield _this.createBIMObject(dbId, name);
        }
      }

      _spinalEnvViewerGraphService.SpinalGraphService.addChild(parent.info.id.get(), node.info.id.get(), REFERENCE_OBJECT_RELATION_NAME, BIM_OBJECT_RELATION_TYPE);
      return node;
    })();
  },

  removeReferenceObject(parent, child) {
    return this.removeBIMObject(parent, child);
  }
};

bimObjectService.constants = {
  BIM_OBJECT_CONTEXT_TYPE,
  BIM_OBJECT_NODE_TYPE,
  BIM_OBJECT_RELATION_NAME,
  REFERENCE_OBJECT_RELATION_NAME,
  BIM_OBJECT_RELATION_TYPE
};

exports.default = bimObjectService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2NyZWF0ZUdyYXBoQmltT2JqZWN0LmpzIl0sIm5hbWVzIjpbIkJJTV9PQkpFQ1RfQ09OVEVYVF9UWVBFIiwiQklNX09CSkVDVF9OT0RFX1RZUEUiLCJCSU1fT0JKRUNUX1JFTEFUSU9OX05BTUUiLCJSRUZFUkVOQ0VfT0JKRUNUX1JFTEFUSU9OX05BTUUiLCJCSU1fT0JKRUNUX1JFTEFUSU9OX1RZUEUiLCJTUElOQUxfUkVMQVRJT05fUFRSX0xTVF9UWVBFIiwiYXNzZW1ibHlNYW5nZXIiLCJhc3NlbWJseU1hbmFnZXJTZXJ2aWNlIiwiYmltT2JqZWN0U2VydmljZSIsImdldEdyYXBoIiwiU3BpbmFsR3JhcGhTZXJ2aWNlIiwiY3JlYXRlQklNT2JqZWN0IiwiZGJpZCIsIm5hbWUiLCJjcmVhdGVCaW1PYmoiLCJfZ2V0Q3VycmVudE1vZGVsIiwiZ2V0QklNT2JqZWN0IiwiZ2V0QmltT2JqZWN0RnJvbVZpZXdlciIsInRoZW4iLCJiaW1PYmoiLCJjb25zb2xlIiwibG9nIiwiZ2V0UmVhbE5vZGUiLCJpZCIsInVuZGVmaW5lZCIsImFkZEJJTU9iamVjdCIsImNvbnRleHQiLCJwYXJlbnQiLCJkYklkIiwiYmltT2JqZWN0IiwiYWRkQ2hpbGRJbkNvbnRleHQiLCJpbmZvIiwiZ2V0IiwiY2F0Y2giLCJlIiwiZXJyb3IiLCJyZW1vdmVCSU1PYmplY3QiLCJjaGlsZCIsInJlbW92ZUNoaWxkIiwiZGVsZXRlQklNT2JqZWN0IiwiQklNb2JqIiwicmVtb3ZlRnJvbUdyYXBoIiwiRXJyb3IiLCJhZGRSZWZlcmVuY2VPYmplY3QiLCJub2RlIiwiU3BpbmFsTm9kZSIsImFkZENoaWxkIiwicmVtb3ZlUmVmZXJlbmNlT2JqZWN0IiwiY29uc3RhbnRzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQTs7QUFLQTs7OztBQUVBLE1BQU1BLDBCQUEwQixrQkFBaEM7QUFDQSxNQUFNQyx1QkFBdUIsV0FBN0I7QUFDQSxNQUFNQywyQkFBMkIsY0FBakM7QUFDQSxNQUFNQyxpQ0FBaUMsb0JBQXZDO0FBQ0EsTUFBTUMsMkJBQTJCQyx5REFBakM7O0FBRUEsTUFBTUMsaUJBQWtCQyxvREFBeEI7QUFDQSxNQUFNQyxtQkFBbUI7O0FBRXZCQyxhQUFVO0FBQ1IsV0FBT0MsZ0RBQW1CRCxRQUFuQixFQUFQO0FBQ0QsR0FKc0I7O0FBTXZCRSxrQkFBZ0JDLElBQWhCLEVBQXNCQyxJQUF0QixFQUE0QjtBQUMxQixXQUFPUCxlQUFlUSxZQUFmLENBQTRCRixJQUE1QixFQUFrQ0MsSUFBbEMsRUFBd0NQLGVBQWVTLGdCQUFmLEVBQXhDLENBQVA7QUFDRCxHQVJzQjs7QUFVdkJDLGVBQWFKLElBQWIsRUFBbUI7QUFDakIsV0FBT04sZUFBZVcsc0JBQWYsQ0FBc0NMLElBQXRDLEVBQTRDTixlQUFlUyxnQkFBZixFQUE1QyxFQUNKRyxJQURJLENBQ0NDLFVBQVU7QUFDZCxVQUFJQSxNQUFKLEVBQVk7QUFDVkMsZ0JBQVFDLEdBQVIsQ0FBYSxRQUFiLEVBQXVCRixNQUF2QjtBQUNBLGVBQU9ULGdEQUFtQlksV0FBbkIsQ0FBK0JILE9BQU9JLEVBQXRDLENBQVA7QUFDRDtBQUNELGFBQU9DLFNBQVA7QUFDRCxLQVBJLENBQVA7QUFRRCxHQW5Cc0I7O0FBcUJ2QkMsZUFBYUMsT0FBYixFQUFzQkMsTUFBdEIsRUFBOEJDLElBQTlCLEVBQW9DZixJQUFwQyxFQUEwQztBQUN4QyxXQUFPLEtBQUtHLFlBQUwsQ0FBa0JZLElBQWxCLEVBQ0pWLElBREksQ0FDQ1csYUFBYTtBQUNqQixVQUFJQSxTQUFKLEVBQWU7QUFDYixlQUFPbkIsZ0RBQW1Cb0IsaUJBQW5CLENBQ0xILE9BQU9JLElBQVAsQ0FBWVIsRUFBWixDQUFlUyxHQUFmLEVBREssRUFDaUJILFVBQVVFLElBQVYsQ0FBZVIsRUFBZixDQUFrQlMsR0FBbEIsRUFEakIsRUFDMENOLFFBQVFLLElBQVIsQ0FBYVIsRUFBYixDQUFnQlMsR0FBaEIsRUFEMUMsRUFFSDlCLHdCQUZHLEVBRXVCRSx3QkFGdkIsQ0FBUDtBQUlEO0FBQ0QsYUFBT0UsZUFBZVEsWUFBZixDQUE0QmMsSUFBNUIsRUFBa0NmLElBQWxDLEVBQXdDUCxlQUFlUyxnQkFBZixFQUF4QyxFQUNKRyxJQURJLENBRUZDLE1BQUQsSUFBWTtBQUNWQyxnQkFBUUMsR0FBUixDQUFZLGFBQVosRUFBMEJGLE1BQTFCO0FBQ0EsZUFBTyxLQUFLTSxZQUFMLENBQWtCQyxPQUFsQixFQUEyQkMsTUFBM0IsRUFBbUNDLElBQW5DLEVBQXlDZixJQUF6QyxDQUFQO0FBQ0QsT0FMRSxDQUFQO0FBT0QsS0FmSSxFQWVGb0IsS0FmRSxDQWVJQyxLQUFLO0FBQUNkLGNBQVFlLEtBQVIsQ0FBY0QsQ0FBZDtBQUFpQixLQWYzQixDQUFQO0FBZ0JELEdBdENzQjs7QUF3Q3ZCRSxrQkFBZ0JULE1BQWhCLEVBQXdCVSxLQUF4QixFQUErQjtBQUM3QjNCLG9EQUFtQjRCLFdBQW5CLENBQ0VYLE9BQU9JLElBQVAsQ0FBWVIsRUFBWixDQUFlUyxHQUFmLEVBREYsRUFFRUssTUFBTU4sSUFBTixDQUFXUixFQUFYLENBQWNTLEdBQWQsRUFGRixFQUdFOUIsd0JBSEYsRUFJRUUsd0JBSkY7QUFNRCxHQS9Dc0I7O0FBaUR2Qm1DLGtCQUFnQlgsSUFBaEIsRUFBc0I7QUFDcEIsV0FBTyxLQUFLWixZQUFMLENBQWtCWSxJQUFsQixFQUF3QlYsSUFBeEIsQ0FDSnNCLE1BQUQsSUFBWTtBQUNWLFVBQUlBLE1BQUosRUFDRSxPQUFPOUIsZ0RBQW1CK0IsZUFBbkIsQ0FBbUNELE9BQU9ULElBQVAsQ0FBWVIsRUFBWixDQUFlUyxHQUFmLEVBQW5DLENBQVA7QUFDRjtBQUNBLFlBQU1VLE1BQU0sNEJBQU4sQ0FBTjtBQUNELEtBTkksQ0FBUDtBQVNELEdBM0RzQjs7QUE2RGpCQyxvQkFBTixDQUF5QmhCLE1BQXpCLEVBQWlDQyxJQUFqQyxFQUF1Q2YsSUFBdkMsRUFBNkM7QUFBQTs7QUFBQTs7QUFFM0MsVUFBSStCLElBQUo7O0FBRUEsVUFBSWhCLGdCQUFnQmlCLHVDQUFwQixFQUFnQztBQUM5QkQsZUFBT2hCLElBQVA7QUFDRCxPQUZELE1BRU87QUFDTGdCLGVBQU8sTUFBTSxNQUFLNUIsWUFBTCxDQUFrQlksSUFBbEIsQ0FBYjs7QUFFQSxZQUFJZ0IsU0FBU3BCLFNBQWIsRUFBd0I7O0FBRXRCb0IsaUJBQU8sTUFBTSxNQUFLakMsZUFBTCxDQUFxQmlCLElBQXJCLEVBQTJCZixJQUEzQixDQUFiO0FBQ0Q7QUFDRjs7QUFFREgsc0RBQ0dvQyxRQURILENBQ1luQixPQUFPSSxJQUFQLENBQVlSLEVBQVosQ0FBZVMsR0FBZixFQURaLEVBQ2tDWSxLQUFLYixJQUFMLENBQVVSLEVBQVYsQ0FBYVMsR0FBYixFQURsQyxFQUVJN0IsOEJBRkosRUFHSUMsd0JBSEo7QUFJQSxhQUFPd0MsSUFBUDtBQW5CMkM7QUFvQjVDLEdBakZzQjs7QUFtRnZCRyx3QkFBc0JwQixNQUF0QixFQUE4QlUsS0FBOUIsRUFBcUM7QUFDbkMsV0FBTyxLQUFLRCxlQUFMLENBQXFCVCxNQUFyQixFQUE2QlUsS0FBN0IsQ0FBUDtBQUNEO0FBckZzQixDQUF6Qjs7QUF3RkE3QixpQkFBaUJ3QyxTQUFqQixHQUE2QjtBQUMzQmhELHlCQUQyQjtBQUUzQkMsc0JBRjJCO0FBRzNCQywwQkFIMkI7QUFJM0JDLGdDQUoyQjtBQUszQkM7QUFMMkIsQ0FBN0I7O2tCQVFlSSxnQiIsImZpbGUiOiJjcmVhdGVHcmFwaEJpbU9iamVjdC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIFNwaW5hbE5vZGUsXG4gIFNQSU5BTF9SRUxBVElPTl9QVFJfTFNUX1RZUEUsXG4gIFNwaW5hbEdyYXBoU2VydmljZVxufSBmcm9tIFwic3BpbmFsLWVudi12aWV3ZXItZ3JhcGgtc2VydmljZVwiO1xuaW1wb3J0IHsgYXNzZW1ibHlNYW5hZ2VyU2VydmljZSB9IGZyb20gXCJzcGluYWwtc2VydmljZS1hc3NlbWJseS1tYW5hZ2VyXCI7XG5cbmNvbnN0IEJJTV9PQkpFQ1RfQ09OVEVYVF9UWVBFID0gXCJCSU1PYmplY3RDb250ZXh0XCI7XG5jb25zdCBCSU1fT0JKRUNUX05PREVfVFlQRSA9IFwiQklNT2JqZWN0XCI7XG5jb25zdCBCSU1fT0JKRUNUX1JFTEFUSU9OX05BTUUgPSBcImhhc0JJTU9iamVjdFwiO1xuY29uc3QgUkVGRVJFTkNFX09CSkVDVF9SRUxBVElPTl9OQU1FID0gXCJoYXNSZWZlcmVuY2VPYmplY3RcIjtcbmNvbnN0IEJJTV9PQkpFQ1RfUkVMQVRJT05fVFlQRSA9IFNQSU5BTF9SRUxBVElPTl9QVFJfTFNUX1RZUEU7XG5cbmNvbnN0IGFzc2VtYmx5TWFuZ2VyID0gIGFzc2VtYmx5TWFuYWdlclNlcnZpY2U7XG5jb25zdCBiaW1PYmplY3RTZXJ2aWNlID0ge1xuICBcbiAgZ2V0R3JhcGgoKXtcbiAgICByZXR1cm4gU3BpbmFsR3JhcGhTZXJ2aWNlLmdldEdyYXBoKCk7XG4gIH0sXG4gIFxuICBjcmVhdGVCSU1PYmplY3QoZGJpZCwgbmFtZSkge1xuICAgIHJldHVybiBhc3NlbWJseU1hbmdlci5jcmVhdGVCaW1PYmooZGJpZCwgbmFtZSwgYXNzZW1ibHlNYW5nZXIuX2dldEN1cnJlbnRNb2RlbCgpKVxuICB9LFxuICBcbiAgZ2V0QklNT2JqZWN0KGRiaWQpIHtcbiAgICByZXR1cm4gYXNzZW1ibHlNYW5nZXIuZ2V0QmltT2JqZWN0RnJvbVZpZXdlcihkYmlkLCBhc3NlbWJseU1hbmdlci5fZ2V0Q3VycmVudE1vZGVsKCkpXG4gICAgICAudGhlbihiaW1PYmogPT4ge1xuICAgICAgICBpZiAoYmltT2JqKSB7XG4gICAgICAgICAgY29uc29sZS5sb2coICdiaW1PYmonLCBiaW1PYmopO1xuICAgICAgICAgIHJldHVybiBTcGluYWxHcmFwaFNlcnZpY2UuZ2V0UmVhbE5vZGUoYmltT2JqLmlkKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgfSk7XG4gIH0sXG4gIFxuICBhZGRCSU1PYmplY3QoY29udGV4dCwgcGFyZW50LCBkYklkLCBuYW1lKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0QklNT2JqZWN0KGRiSWQpXG4gICAgICAudGhlbihiaW1PYmplY3QgPT4ge1xuICAgICAgICBpZiAoYmltT2JqZWN0KSB7XG4gICAgICAgICAgcmV0dXJuIFNwaW5hbEdyYXBoU2VydmljZS5hZGRDaGlsZEluQ29udGV4dChcbiAgICAgICAgICAgIHBhcmVudC5pbmZvLmlkLmdldCgpLCBiaW1PYmplY3QuaW5mby5pZC5nZXQoKSwgY29udGV4dC5pbmZvLmlkLmdldCgpXG4gICAgICAgICAgICAsIEJJTV9PQkpFQ1RfUkVMQVRJT05fTkFNRSwgQklNX09CSkVDVF9SRUxBVElPTl9UWVBFLFxuICAgICAgICAgIClcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYXNzZW1ibHlNYW5nZXIuY3JlYXRlQmltT2JqKGRiSWQsIG5hbWUsIGFzc2VtYmx5TWFuZ2VyLl9nZXRDdXJyZW50TW9kZWwoKSlcbiAgICAgICAgICAudGhlbihcbiAgICAgICAgICAgIChiaW1PYmopID0+IHtcbiAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2NyZWF0ZSB0aGVuJyxiaW1PYmopO1xuICAgICAgICAgICAgICByZXR1cm4gdGhpcy5hZGRCSU1PYmplY3QoY29udGV4dCwgcGFyZW50LCBkYklkLCBuYW1lKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICApXG4gICAgICB9KS5jYXRjaChlID0+IHtjb25zb2xlLmVycm9yKGUpfSlcbiAgfSxcbiAgXG4gIHJlbW92ZUJJTU9iamVjdChwYXJlbnQsIGNoaWxkKSB7XG4gICAgU3BpbmFsR3JhcGhTZXJ2aWNlLnJlbW92ZUNoaWxkKFxuICAgICAgcGFyZW50LmluZm8uaWQuZ2V0KCksXG4gICAgICBjaGlsZC5pbmZvLmlkLmdldCgpLFxuICAgICAgQklNX09CSkVDVF9SRUxBVElPTl9OQU1FLFxuICAgICAgQklNX09CSkVDVF9SRUxBVElPTl9UWVBFXG4gICAgKTtcbiAgfSxcbiAgXG4gIGRlbGV0ZUJJTU9iamVjdChkYklkKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0QklNT2JqZWN0KGRiSWQpLnRoZW4oXG4gICAgICAoQklNb2JqKSA9PiB7XG4gICAgICAgIGlmIChCSU1vYmopXG4gICAgICAgICAgcmV0dXJuIFNwaW5hbEdyYXBoU2VydmljZS5yZW1vdmVGcm9tR3JhcGgoQklNb2JqLmluZm8uaWQuZ2V0KCkpO1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIHRocm93IEVycm9yKFwiVGhlIGRiSWQgaGFzIG5vIEJJTSBvYmplY3RcIik7XG4gICAgICB9XG4gICAgKVxuICAgIFxuICB9LFxuICBcbiAgYXN5bmMgYWRkUmVmZXJlbmNlT2JqZWN0KHBhcmVudCwgZGJJZCwgbmFtZSkge1xuICAgIFxuICAgIGxldCBub2RlO1xuICAgIFxuICAgIGlmIChkYklkIGluc3RhbmNlb2YgU3BpbmFsTm9kZSkge1xuICAgICAgbm9kZSA9IGRiSWQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIG5vZGUgPSBhd2FpdCB0aGlzLmdldEJJTU9iamVjdChkYklkKTtcbiAgICAgIFxuICAgICAgaWYgKG5vZGUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBcbiAgICAgICAgbm9kZSA9IGF3YWl0IHRoaXMuY3JlYXRlQklNT2JqZWN0KGRiSWQsIG5hbWUpO1xuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICBTcGluYWxHcmFwaFNlcnZpY2VcbiAgICAgIC5hZGRDaGlsZChwYXJlbnQuaW5mby5pZC5nZXQoKSwgbm9kZS5pbmZvLmlkLmdldCgpLFxuICAgICAgICBSRUZFUkVOQ0VfT0JKRUNUX1JFTEFUSU9OX05BTUUsXG4gICAgICAgIEJJTV9PQkpFQ1RfUkVMQVRJT05fVFlQRSk7XG4gICAgcmV0dXJuIG5vZGU7XG4gIH0sXG4gIFxuICByZW1vdmVSZWZlcmVuY2VPYmplY3QocGFyZW50LCBjaGlsZCkge1xuICAgIHJldHVybiB0aGlzLnJlbW92ZUJJTU9iamVjdChwYXJlbnQsIGNoaWxkKVxuICB9LFxufTtcblxuYmltT2JqZWN0U2VydmljZS5jb25zdGFudHMgPSB7XG4gIEJJTV9PQkpFQ1RfQ09OVEVYVF9UWVBFLFxuICBCSU1fT0JKRUNUX05PREVfVFlQRSxcbiAgQklNX09CSkVDVF9SRUxBVElPTl9OQU1FLFxuICBSRUZFUkVOQ0VfT0JKRUNUX1JFTEFUSU9OX05BTUUsXG4gIEJJTV9PQkpFQ1RfUkVMQVRJT05fVFlQRVxufTtcblxuZXhwb3J0IGRlZmF1bHQgYmltT2JqZWN0U2VydmljZTtcbiJdfQ==
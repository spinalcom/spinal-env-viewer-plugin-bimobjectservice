"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _spinalEnvViewerGraphService = require("spinal-env-viewer-graph-service");

var _spinalModelsBimobject = require("spinal-models-bimobject");

var _spinalModelsBimobject2 = _interopRequireDefault(_spinalModelsBimobject);

var _spinalServiceAssemblyManager = require("spinal-service-assembly-manager");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

const BIM_OBJECT_CONTEXT_TYPE = "BIMObjectContext";
const BIM_OBJECT_NODE_TYPE = "BIMObject";
const BIM_OBJECT_RELATION_NAME = "hasBIMObject";
const REFERENCE_OBJECT_RELATION_NAME = "hasReferenceObject";
const BIM_OBJECT_RELATION_TYPE = _spinalEnvViewerGraphService.SPINAL_RELATION_PTR_LST_TYPE;

const assemblyManger = _spinalServiceAssemblyManager.assemblyManagerService;
const bimObjectService = {
  createBIMObject(dbid, name) {
    return assemblyManger.createBimObj(dbid, name, assemblyManger._getCurrentModel());
  },

  getBIMObject(dbid) {
    return assemblyManger.getBimObjectFromViewer(dbid, assemblyManger._getCurrentModel()).then(bimObj => {
      if (bimObj) {
        console.log('bimObj', bimObj);
        return _spinalEnvViewerGraphService.SpinalGraphService.getRealNode(bimObj.id);
      }
      return undefined;
    });
  },

  addBIMObject(context, parent, dbId, name) {
    return this.getBIMObject(dbId).then(bimObject => {
      if (bimObject) {
        return _spinalEnvViewerGraphService.SpinalGraphService.addChildInContext(parent.info.id.get(), bimObject.info.id.get(), context.info.id.get(), BIM_OBJECT_RELATION_NAME, BIM_OBJECT_RELATION_TYPE);
      }
      return assemblyManger.createBimObj(dbId, name, assemblyManger._getCurrentModel()).then(bimObj => {
        console.log('create then', bimObj);
        return this.addBIMObject(context, parent, dbId, name);
      });
    }).catch(e => {
      console.error(e);
    });
  },

  removeBIMObject(parent, child) {
    _spinalEnvViewerGraphService.SpinalGraphService.removeChild(parent.info.id.get(), child.info.id.get(), BIM_OBJECT_RELATION_NAME, BIM_OBJECT_RELATION_TYPE);
  },

  deleteBIMObject(dbId) {
    return this.getBIMObject(dbId).then(BIMobj => {
      if (BIMobj) return _spinalEnvViewerGraphService.SpinalGraphService.removeFromGraph(BIMobj.info.id.get());
      // @ts-ignore
      throw Error("The dbId has no BIM object");
    });
  },

  addReferenceObject(parent, dbId, name) {
    var _this = this;

    return _asyncToGenerator(function* () {

      let node;

      if (dbId instanceof _spinalEnvViewerGraphService.SpinalNode) {
        node = dbId;
      } else {
        node = yield _this.getBIMObject(dbId);

        if (node === undefined) {

          node = yield _this.createBIMObject(dbId, name);
        }
      }

      _spinalEnvViewerGraphService.SpinalGraphService.addChild(parent.info.id.get(), node.info.id.get(), REFERENCE_OBJECT_RELATION_NAME, BIM_OBJECT_RELATION_TYPE);
      return node;
    })();
  },

  removeReferenceObject(parent, child) {
    return this.removeBIMObject(parent, child);
  }
};

bimObjectService.constants = {
  BIM_OBJECT_CONTEXT_TYPE,
  BIM_OBJECT_NODE_TYPE,
  BIM_OBJECT_RELATION_NAME,
  REFERENCE_OBJECT_RELATION_NAME,
  BIM_OBJECT_RELATION_TYPE
};

exports.default = bimObjectService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2NyZWF0ZUdyYXBoQmltT2JqZWN0LmpzIl0sIm5hbWVzIjpbIkJJTV9PQkpFQ1RfQ09OVEVYVF9UWVBFIiwiQklNX09CSkVDVF9OT0RFX1RZUEUiLCJCSU1fT0JKRUNUX1JFTEFUSU9OX05BTUUiLCJSRUZFUkVOQ0VfT0JKRUNUX1JFTEFUSU9OX05BTUUiLCJCSU1fT0JKRUNUX1JFTEFUSU9OX1RZUEUiLCJTUElOQUxfUkVMQVRJT05fUFRSX0xTVF9UWVBFIiwiYXNzZW1ibHlNYW5nZXIiLCJhc3NlbWJseU1hbmFnZXJTZXJ2aWNlIiwiYmltT2JqZWN0U2VydmljZSIsImNyZWF0ZUJJTU9iamVjdCIsImRiaWQiLCJuYW1lIiwiY3JlYXRlQmltT2JqIiwiX2dldEN1cnJlbnRNb2RlbCIsImdldEJJTU9iamVjdCIsImdldEJpbU9iamVjdEZyb21WaWV3ZXIiLCJ0aGVuIiwiYmltT2JqIiwiY29uc29sZSIsImxvZyIsIlNwaW5hbEdyYXBoU2VydmljZSIsImdldFJlYWxOb2RlIiwiaWQiLCJ1bmRlZmluZWQiLCJhZGRCSU1PYmplY3QiLCJjb250ZXh0IiwicGFyZW50IiwiZGJJZCIsImJpbU9iamVjdCIsImFkZENoaWxkSW5Db250ZXh0IiwiaW5mbyIsImdldCIsImNhdGNoIiwiZSIsImVycm9yIiwicmVtb3ZlQklNT2JqZWN0IiwiY2hpbGQiLCJyZW1vdmVDaGlsZCIsImRlbGV0ZUJJTU9iamVjdCIsIkJJTW9iaiIsInJlbW92ZUZyb21HcmFwaCIsIkVycm9yIiwiYWRkUmVmZXJlbmNlT2JqZWN0Iiwibm9kZSIsIlNwaW5hbE5vZGUiLCJhZGRDaGlsZCIsInJlbW92ZVJlZmVyZW5jZU9iamVjdCIsImNvbnN0YW50cyJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUE7O0FBS0E7Ozs7QUFDQTs7Ozs7O0FBRUEsTUFBTUEsMEJBQTBCLGtCQUFoQztBQUNBLE1BQU1DLHVCQUF1QixXQUE3QjtBQUNBLE1BQU1DLDJCQUEyQixjQUFqQztBQUNBLE1BQU1DLGlDQUFp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QUFFQSxZQUFJZ0IsU0FBU3BCLFNBQWIsRUFBd0I7O0FBRXRCb0IsaUJBQU8sTUFBTSxNQUFLbEMsZUFBTCxDQUFxQmtCLElBQXJCLEVBQTJCaEIsSUFBM0IsQ0FBYjtBQUNEO0FBQ0Y7O0FBRURTLHNEQUNHeUIsUUFESCxDQUNZbkIsT0FBT0ksSUFBUCxDQUFZUixFQUFaLENBQWVTLEdBQWYsRUFEWixFQUNrQ1ksS0FBS2IsSUFBTCxDQUFVUixFQUFWLENBQWFTLEdBQWIsRUFEbEMsRUFFSTVCLDhCQUZKLEVBR0lDLHdCQUhKO0FBSUEsYUFBT3VDLElBQVA7QUFuQjJDO0FBb0I1QyxHQTVFc0I7O0FBOEV2Qkcsd0JBQXNCcEIsTUFBdEIsRUFBOEJVLEtBQTlCLEVBQXFDO0FBQ25DLFdBQU8sS0FBS0QsZUFBTCxDQUFxQlQsTUFBckIsRUFBNkJVLEtBQTdCLENBQVA7QUFDRDtBQWhGc0IsQ0FBekI7O0FBbUZBNUIsaUJBQWlCdUMsU0FBakIsR0FBNkI7QUFDM0IvQyx5QkFEMkI7QUFFM0JDLHNCQUYyQjtBQUczQkMsMEJBSDJCO0FBSTNCQyxnQ0FKMkI7QUFLM0JDO0FBTDJCLENBQTdCOztrQkFRZUksZ0IiLCJmaWxlIjoiY3JlYXRlR3JhcGhCaW1PYmplY3QuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBTcGluYWxOb2RlLFxuICBTUElOQUxfUkVMQVRJT05fUFRSX0xTVF9UWVBFLFxuICBTcGluYWxHcmFwaFNlcnZpY2Vcbn0gZnJvbSBcInNwaW5hbC1lbnYtdmlld2VyLWdyYXBoLXNlcnZpY2VcIjtcbmltcG9ydCBTcGluYWxCSU1PYmplY3QgZnJvbSBcInNwaW5hbC1tb2RlbHMtYmltb2JqZWN0XCI7XG5pbXBvcnQgeyBhc3NlbWJseU1hbmFnZXJTZXJ2aWNlIH0gZnJvbSBcInNwaW5hbC1zZXJ2aWNlLWFzc2VtYmx5LW1hbmFnZXJcIjtcblxuY29uc3QgQklNX09CSkVDVF9DT05URVhUX1RZUEUgPSBcIkJJTU9iamVjdENvbnRleHRcIjtcbmNvbnN0IEJJTV9PQkpFQ1RfTk9ERV9UWVBFID0gXCJCSU1PYmplY3RcIjtcbmNvbnN0IEJJTV9PQkpFQ1RfUkVMQVRJT05fTkFNRSA9IFwiaGFzQklNT2JqZWN0XCI7XG5jb25zdCBSRUZFUkVOQ0VfT0JKRUNUX1JFTEFUSU9OX05BTUUgPSBcImhhc1JlZmVyZW5jZU9iamVjdFwiO1xuY29uc3QgQklNX09CSkVDVF9SRUxBVElPTl9UWVBFID0gU1BJTkFMX1JFTEFUSU9OX1BUUl9MU1RfVFlQRTtcblxuY29uc3QgYXNzZW1ibHlNYW5nZXIgPSAgYXNzZW1ibHlNYW5hZ2VyU2VydmljZTtcbmNvbnN0IGJpbU9iamVjdFNlcnZpY2UgPSB7XG4gIGNyZWF0ZUJJTU9iamVjdChkYmlkLCBuYW1lKSB7XG4gICAgcmV0dXJuIGFzc2VtYmx5TWFuZ2VyLmNyZWF0ZUJpbU9iaihkYmlkLCBuYW1lLCBhc3NlbWJseU1hbmdlci5fZ2V0Q3VycmVudE1vZGVsKCkpXG4gIH0sXG4gIFxuICBnZXRCSU1PYmplY3QoZGJpZCkge1xuICAgIHJldHVybiBhc3NlbWJseU1hbmdlci5nZXRCaW1PYmplY3RGcm9tVmlld2VyKGRiaWQsIGFzc2VtYmx5TWFuZ2VyLl9nZXRDdXJyZW50TW9kZWwoKSlcbiAgICAgIC50aGVuKGJpbU9iaiA9PiB7XG4gICAgICAgIGlmIChiaW1PYmopIHtcbiAgICAgICAgICBjb25zb2xlLmxvZyggJ2JpbU9iaicsIGJpbU9iaik7XG4gICAgICAgICAgcmV0dXJuIFNwaW5hbEdyYXBoU2VydmljZS5nZXRSZWFsTm9kZShiaW1PYmouaWQpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICB9KTtcbiAgfSxcbiAgXG4gIGFkZEJJTU9iamVjdChjb250ZXh0LCBwYXJlbnQsIGRiSWQsIG5hbWUpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRCSU1PYmplY3QoZGJJZClcbiAgICAgIC50aGVuKGJpbU9iamVjdCA9PiB7XG4gICAgICAgIGlmIChiaW1PYmplY3QpIHtcbiAgICAgICAgICByZXR1cm4gU3BpbmFsR3JhcGhTZXJ2aWNlLmFkZENoaWxkSW5Db250ZXh0KFxuICAgICAgICAgICAgcGFyZW50LmluZm8uaWQuZ2V0KCksIGJpbU9iamVjdC5pbmZvLmlkLmdldCgpLCBjb250ZXh0LmluZm8uaWQuZ2V0KClcbiAgICAgICAgICAgICwgQklNX09CSkVDVF9SRUxBVElPTl9OQU1FLCBCSU1fT0JKRUNUX1JFTEFUSU9OX1RZUEUsXG4gICAgICAgICAgKVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBhc3NlbWJseU1hbmdlci5jcmVhdGVCaW1PYmooZGJJZCwgbmFtZSwgYXNzZW1ibHlNYW5nZXIuX2dldEN1cnJlbnRNb2RlbCgpKVxuICAgICAgICAgIC50aGVuKFxuICAgICAgICAgICAgKGJpbU9iaikgPT4ge1xuICAgICAgICAgICAgICBjb25zb2xlLmxvZygnY3JlYXRlIHRoZW4nLGJpbU9iaik7XG4gICAgICAgICAgICAgIHJldHVybiB0aGlzLmFkZEJJTU9iamVjdChjb250ZXh0LCBwYXJlbnQsIGRiSWQsIG5hbWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIClcbiAgICAgIH0pLmNhdGNoKGUgPT4ge2NvbnNvbGUuZXJyb3IoZSl9KVxuICB9LFxuICBcbiAgcmVtb3ZlQklNT2JqZWN0KHBhcmVudCwgY2hpbGQpIHtcbiAgICBTcGluYWxHcmFwaFNlcnZpY2UucmVtb3ZlQ2hpbGQoXG4gICAgICBwYXJlbnQuaW5mby5pZC5nZXQoKSxcbiAgICAgIGNoaWxkLmluZm8uaWQuZ2V0KCksXG4gICAgICBCSU1fT0JKRUNUX1JFTEFUSU9OX05BTUUsXG4gICAgICBCSU1fT0JKRUNUX1JFTEFUSU9OX1RZUEVcbiAgICApO1xuICB9LFxuICBcbiAgZGVsZXRlQklNT2JqZWN0KGRiSWQpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRCSU1PYmplY3QoZGJJZCkudGhlbihcbiAgICAgIChCSU1vYmopID0+IHtcbiAgICAgICAgaWYgKEJJTW9iailcbiAgICAgICAgICByZXR1cm4gU3BpbmFsR3JhcGhTZXJ2aWNlLnJlbW92ZUZyb21HcmFwaChCSU1vYmouaW5mby5pZC5nZXQoKSk7XG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgdGhyb3cgRXJyb3IoXCJUaGUgZGJJZCBoYXMgbm8gQklNIG9iamVjdFwiKTtcbiAgICAgIH1cbiAgICApXG4gICAgXG4gIH0sXG4gIFxuICBhc3luYyBhZGRSZWZlcmVuY2VPYmplY3QocGFyZW50LCBkYklkLCBuYW1lKSB7XG4gICAgXG4gICAgbGV0IG5vZGU7XG4gICAgXG4gICAgaWYgKGRiSWQgaW5zdGFuY2VvZiBTcGluYWxOb2RlKSB7XG4gICAgICBub2RlID0gZGJJZDtcbiAgICB9IGVsc2Uge1xuICAgICAgbm9kZSA9IGF3YWl0IHRoaXMuZ2V0QklNT2JqZWN0KGRiSWQpO1xuICAgICAgXG4gICAgICBpZiAobm9kZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIFxuICAgICAgICBub2RlID0gYXdhaXQgdGhpcy5jcmVhdGVCSU1PYmplY3QoZGJJZCwgbmFtZSk7XG4gICAgICB9XG4gICAgfVxuICAgIFxuICAgIFNwaW5hbEdyYXBoU2VydmljZVxuICAgICAgLmFkZENoaWxkKHBhcmVudC5pbmZvLmlkLmdldCgpLCBub2RlLmluZm8uaWQuZ2V0KCksXG4gICAgICAgIFJFRkVSRU5DRV9PQkpFQ1RfUkVMQVRJT05fTkFNRSxcbiAgICAgICAgQklNX09CSkVDVF9SRUxBVElPTl9UWVBFKTtcbiAgICByZXR1cm4gbm9kZTtcbiAgfSxcbiAgXG4gIHJlbW92ZVJlZmVyZW5jZU9iamVjdChwYXJlbnQsIGNoaWxkKSB7XG4gICAgcmV0dXJuIHRoaXMucmVtb3ZlQklNT2JqZWN0KHBhcmVudCwgY2hpbGQpXG4gIH0sXG59O1xuXG5iaW1PYmplY3RTZXJ2aWNlLmNvbnN0YW50cyA9IHtcbiAgQklNX09CSkVDVF9DT05URVhUX1RZUEUsXG4gIEJJTV9PQkpFQ1RfTk9ERV9UWVBFLFxuICBCSU1fT0JKRUNUX1JFTEFUSU9OX05BTUUsXG4gIFJFRkVSRU5DRV9PQkpFQ1RfUkVMQVRJT05fTkFNRSxcbiAgQklNX09CSkVDVF9SRUxBVElPTl9UWVBFXG59O1xuXG5leHBvcnQgZGVmYXVsdCBiaW1PYmplY3RTZXJ2aWNlO1xuIl19